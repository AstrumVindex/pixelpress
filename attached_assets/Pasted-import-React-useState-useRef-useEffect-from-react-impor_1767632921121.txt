import React, { useState, useRef, useEffect } from 'react';
import { CloudUpload, Zap, FileType, CheckCircle, ChevronDown, Menu, FileText, Download, X, AlertCircle, Images } from 'lucide-react';
import * as pdfjsLib from 'pdfjs-dist';
import jsPDF from 'jspdf';
import JSZip from 'jszip';
import { saveAs } from 'file-saver';

// --- PDF.js Worker Setup ---
pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjsLib.version}/pdf.worker.min.js`;

export default function PixelPressConverter() {
  const [file, setFile] = useState<File | null>(null);
  const [isDragging, setIsDragging] = useState(false);
  const [targetFormat, setTargetFormat] = useState<string>('jpg');
  const [isConverting, setIsConverting] = useState(false);
  // downloadUrl is for single files, isZipDownloaded tracks auto-downloaded zips
  const [downloadUrl, setDownloadUrl] = useState<string | null>(null);
  const [isZipDownloaded, setIsZipDownloaded] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [progressTxt, setProgressTxt] = useState('Processing...');
  
  const fileInputRef = useRef<HTMLInputElement>(null);

  // --- 1. File Handling & UI States ---
  const handleDragOver = (e: React.DragEvent) => { e.preventDefault(); setIsDragging(true); };
  const handleDragLeave = () => { setIsDragging(false); };
  
  const resetState = () => {
      setFile(null); setDownloadUrl(null); setIsZipDownloaded(false); setErrorMsg(null); setProgressTxt('Processing...');
  }

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault(); setIsDragging(false);
    if (e.dataTransfer.files?.[0]) processFile(e.dataTransfer.files[0]);
  };

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files?.[0]) processFile(e.target.files[0]);
  };

  const processFile = (selectedFile: File) => {
    resetState();
    setFile(selectedFile);

    // Smart Format Selection Defaults
    if (selectedFile.type === 'application/pdf') {
      setTargetFormat('jpg_zip'); 
    } else if (selectedFile.type.startsWith('image/')) {
      // Default image to PDF as it's a common request, or jpg otherwise
      setTargetFormat(selectedFile.type === 'image/jpeg' ? 'pdf' : 'jpg');
    }
  };

  // --- 2. Conversion Logic Engines ---

  // ENGINE A: Image -> Image (Canvas API) handles WebP<->JPG/PNG
  const convertImageToImage = async (format: string) => {
    if (!file) return;
    const imageBitmap = await createImageBitmap(file);
    const canvas = document.createElement('canvas');
    canvas.width = imageBitmap.width;
    canvas.height = imageBitmap.height;
    const ctx = canvas.getContext('2d');
    if (!ctx) throw new Error('Canvas error');

    // Handle transparency for JPG
    if (format === 'jpeg') {
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    ctx.drawImage(imageBitmap, 0, 0);

    return new Promise<void>((resolve, reject) => {
      canvas.toBlob((blob) => {
        if (blob) {
             setDownloadUrl(URL.createObjectURL(blob));
             resolve();
        } else reject(new Error('Image conversion failed'));
      }, `image/${format}`, 0.92);
    });
  };

  // ENGINE B: Image -> PDF (jsPDF)
  const convertImageToPdf = async () => {
      if (!file) return;
      setProgressTxt('Generating PDF...');
      
      // Load image to get natural dimensions
      const img = new Image();
      img.src = URL.createObjectURL(file);
      await new Promise(r => img.onload = r);

      // Create PDF matching image dimensions exactly (using pixels as units)
      const doc = new jsPDF({
        orientation: img.width > img.height ? 'l' : 'p',
        unit: 'px',
        format: [img.width, img.height]
      });
      
      doc.addImage(img, file.type.split('/')[1].toUpperCase(), 0, 0, img.width, img.height);
      const pdfBlob = doc.output('blob');
      setDownloadUrl(URL.createObjectURL(pdfBlob));
  };


  // ENGINE C: PDF -> JPG ZIP (pdf.js + jszip)
  const convertPdfToJpgZip = async () => {
    if (!file) return;
    const zip = new JSZip();
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const totalPages = pdf.numPages;

    for (let i = 1; i <= totalPages; i++) {
      setProgressTxt(`Processing page ${i} of ${totalPages}...`);
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: 2 }); // Scale 2 for sharp quality
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      if (!context) throw new Error('Canvas context missing');
      await page.render({ canvasContext: context, viewport: viewport }).promise;

      // Convert canvas to blob promise
      const blob = await new Promise<Blob | null>(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
      if (blob) {
          // Add to zip folder with padded filename (page-01.jpg)
          const fileName = `page-${String(i).padStart(2, '0')}.jpg`;
          zip.file(fileName, blob);
      }
    }

    setProgressTxt('Zipping files...');
    const zipContent = await zip.generateAsync({type:"blob"});
    // Trigger save directly, no need for a download link button
    saveAs(zipContent, `${file.name.split('.')[0]}-images.zip`);
    setIsZipDownloaded(true);
  };


  // --- Main Processor Switch ---
  const handleConvert = async () => {
    if (!file) return;
    setIsConverting(true);
    setErrorMsg(null);
    setProgressTxt('Initializing...');

    try {
      const inputType = file.type;

      // 1. PDF Input -> JPG ZIP Output
      if (inputType === 'application/pdf') {
        if (targetFormat === 'jpg_zip') await convertPdfToJpgZip();
      }
      // 2. Image Input -> Various Outputs
      else if (inputType.startsWith('image/')) {
         if (targetFormat === 'pdf') {
             await convertImageToPdf();
         } else if (['jpeg', 'png', 'webp'].includes(targetFormat)) {
             await convertImageToImage(targetFormat);
         }
      } 
      else {
        throw new Error("Unsupported file type requested.");
      }
    } catch (err: any) {
      console.error(err);
      setErrorMsg(err.message || "Conversion failed. The file might be corrupted.");
    } finally {
      setIsConverting(false);
    }
  };

  // Helper: Available formats based on input file type
  const getAvailableFormats = () => {
    if (!file) return [];
    if (file.type === 'application/pdf') {
        return [{ val: 'jpg_zip', label: 'JPG Images (ZIP Archive)' }];
    }
    if (file.type.startsWith('image/')) {
        return [
            { val: 'pdf', label: 'PDF Document' },
            { val: 'jpeg', label: 'JPG Image' },
            { val: 'png', label: 'PNG Image' },
            { val: 'webp', label: 'WEBP Image' }
        ].filter(fmt => !file.type.includes(fmt.val)); // Don't show convert JPG to JPG
    }
    return [];
  };

  const isDone = downloadUrl || isZipDownloaded;

  return (
    <div className="min-h-screen bg-white font-sans text-slate-900">
      <nav className="flex items-center justify-between px-6 py-4 max-w-7xl mx-auto border-b border-slate-50 md:border-none">
        <div className="flex items-center gap-2">
          <div className="bg-purple-100 p-2 rounded-lg text-purple-600">
            <Zap size={20} fill="currentColor" />
          </div>
          <span className="text-xl font-bold tracking-tight text-slate-800">PixelPress</span>
        </div>
      </nav>

      <main className="flex flex-col items-center justify-center mt-8 md:mt-12 px-4 pb-20">
        <h1 className="text-4xl md:text-5xl font-extrabold text-center leading-tight tracking-tight text-slate-900 mb-4">
          Document & Image Converter<br />
          <span className="text-purple-600">Client-Side Privacy</span>
        </h1>
        
        <p className="text-slate-500 text-center max-w-2xl text-lg mb-10">
          Convert PDF to JPGs, JPG to PDF, or switch between WebP/PNG formats.
          Runs entirely in your browser.
        </p>

        <div 
          className={`relative w-full max-w-2xl bg-white rounded-3xl p-8 md:p-12 text-center transition-all duration-300 border-[3px] 
            ${isDragging ? 'border-purple-500 bg-purple-50 scale-[1.02]' : 'border-dashed border-slate-200 shadow-[0_8px_30px_rgb(0,0,0,0.04)]'}
            ${file ? 'border-solid border-purple-100 ring-4 ring-purple-50/50' : ''}
          `}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onDrop={handleDrop}
        >
          {!file ? (
            /* STATE 1: Upload */
            <div className="flex flex-col items-center justify-center gap-5">
              <div className="w-20 h-20 bg-gradient-to-br from-purple-50 to-white rounded-2xl shadow-sm border border-slate-100 flex items-center justify-center text-purple-600 mb-2">
                <CloudUpload size={40} strokeWidth={1.5} />
              </div>
              <div>
                <h3 className="text-xl font-bold text-slate-800 mb-2">Upload File</h3>
                <p className="text-slate-400 text-sm">
                  Drag & Drop or Click to Browse<br/>
                  <span className="text-xs font-semibold text-slate-300 uppercase mt-2 block">
                    PDF • JPG • PNG • WEBP
                  </span>
                </p>
              </div>
              <button 
                onClick={() => fileInputRef.current?.click()}
                className="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg shadow-purple-200 transition-all transform hover:scale-105 active:scale-95"
              >
                Select File
              </button>
            </div>
          ) : (
            /* STATE 2: Process/Finished */
            <div className="flex flex-col items-center animate-in fade-in slide-in-from-bottom-4 duration-500">
              
              {/* File Info Card */}
              <div className="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 flex items-center justify-between mb-8">
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center text-purple-600 shadow-sm">
                    {file.type === 'application/pdf' ? <FileText size={24}/> : <Images size={24}/>}
                  </div>
                  <div className="text-left">
                    <p className="font-bold text-slate-800 truncate max-w-[150px] md:max-w-[250px]">{file.name}</p>
                    <p className="text-xs text-slate-500">{(file.size / 1024 / 1024).toFixed(2)} MB</p>
                  </div>
                </div>
                {!isConverting && (
                <button onClick={resetState} className="p-2 hover:bg-slate-200 rounded-full text-slate-400 hover:text-slate-600">
                  <X size={20} />
                </button>
                )}
              </div>

              {errorMsg && (
                <div className="w-full bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 flex items-center gap-2 animate-in slide-in-from-top-2">
                  <AlertCircle size={16} /> {errorMsg}
                </div>
              )}

              {/* Controls area */}
              {!isDone ? (
                <div className="flex flex-col md:flex-row items-center gap-4 w-full justify-center">
                  <div className="flex items-center gap-2 bg-white border border-slate-300 rounded-lg px-4 py-3 relative w-full md:w-auto">
                    <span className="text-sm text-slate-500 font-medium whitespace-nowrap">Convert to:</span>
                    <select 
                      value={targetFormat}
                      onChange={(e) => setTargetFormat(e.target.value)}
                      disabled={isConverting}
                      className="bg-transparent font-bold text-slate-800 outline-none appearance-none pr-8 cursor-pointer w-full"
                    >
                      {getAvailableFormats().map(fmt => (
                        <option key={fmt.val} value={fmt.val}>{fmt.label}</option>
                      ))}
                    </select>
                    <ChevronDown size={14} className="absolute right-3 text-slate-800 pointer-events-none"/>
                  </div>

                  <button 
                    onClick={handleConvert}
                    disabled={isConverting || getAvailableFormats().length === 0}
                    className="w-full md:w-auto bg-purple-600 hover:bg-purple-700 disabled:bg-slate-300 disabled:text-slate-500 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all flex items-center justify-center gap-2 min-w-[180px]"
                  >
                    {isConverting ? (
                        <span className="flex items-center gap-2 text-sm"><Zap size={16} className="animate-pulse"/> {progressTxt}</span>
                    ) : 'Convert Now'}
                  </button>
                </div>
              ) : (
                 /* STATE 3: Download area */
                <div className="flex flex-col gap-4 w-full max-w-xs animate-in zoom-in-95">
                   <div className="bg-green-50 text-green-700 px-4 py-4 rounded-xl text-sm font-medium flex flex-col items-center justify-center gap-2">
                      <CheckCircle size={24} className="text-green-500 mb-1" /> 
                      {isZipDownloaded ? "Conversion finished! ZIP downloaded." : "File ready for download."}
                   </div>
                   
                   {downloadUrl && (
                   <a 
                    href={downloadUrl}
                    download={`converted-file.${targetFormat === 'jpeg' ? 'jpg' : targetFormat}`}
                    className="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 transform hover:-translate-y-1"
                  >
                    Download File <Download size={20} />
                  </a>
                   )}

                  <button onClick={resetState} className="text-sm text-slate-400 hover:text-slate-600 underline mt-2">
                    Convert another file
                  </button>
                </div>
              )}
            </div>
          )}

          {/* Hidden Input field */}
          <input 
            type="file" 
            className="hidden" 
            ref={fileInputRef} 
            // Accept images and PDFs
            accept="image/png, image/jpeg, image/webp, application/pdf"
            onChange={handleFileSelect}
          />
        </div>
      </main>
    </div>
  );
}